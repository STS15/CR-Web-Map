<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>College of the Redwoods · Campus Map</title>

    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;600;700&family=Merriweather:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
    <link rel="stylesheet" href="/static/css/styles.css">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="/static/js/client.js"></script>
</head>
<body>
<header class="appbar">
    <div class="brand">
        <img src="https://www.redwoods.edu/images/CR_logo.svg" alt="College of the Redwoods logo" />
        <h1><span class="hide-on-mobile"><%= isAdmin ? 'Admin' : 'Campus Map' %></span></h1>
    </div>

    <% if (messages && messages.success && messages.success.length) { %>
        <span class="badge"><%= messages.success.join(", ") %></span>
    <% } %>
    <% if (messages && messages.error && messages.error.length) { %>
        <span class="badge" style="background:#ffebee; color:#8e001c"><%= messages.error.join(", ") %></span>
    <% } %>

    <form action="<%= isAdmin ? '/logout' : '/login' %>" method="post" class="actions">
        <% if (!isAdmin) { %>
            <input name="password" type="password" placeholder="Admin password" />
            <button type="submit" class="ghost">Login</button>
            <a class="btn secondary" href="/admin" title="Admin">Admin</a>
        <% } else { %>
            <button type="submit">Logout</button>
            <a class="btn secondary" href="/">Map</a>
        <% } %>
    </form>
</header>


<div id="map"></div>
<div class="sidebar" id="route-sidebar">
    <header>
        <h3 style="margin:0">Walking Directions</h3>
    </header>
    <main>
        <p style="margin-top:0">
            Click <b>Start</b>, then click the map where you are.
            Then click <b>Destination</b> and click your destination.
        </p>

        <fieldset>
            <legend>Pick points</legend>
            <button class="btn" id="route-set-start">Set start</button>
            <button class="btn" id="route-set-end">Set destination</button>
            <button class="btn secondary" id="route-clear">Clear</button>
        </fieldset>

        <fieldset>
            <legend>Details</legend>
            <div><span class="mono" id="route-start-label">Start: —</span></div>
            <div><span class="mono" id="route-end-label">End: —</span></div>
            <div><span class="mono" id="route-distance-label">Distance: —</span></div>
        </fieldset>
    </main>
</div>
<footer class="toasts" id="toasts"></footer>

<script>
    (async function () {
        const map = CR.initMap("map");
        const [features, walkways] = await Promise.all([
            CR.fetchFeatures(),
            CR.fetchWalkways()
        ]);

        const featuresLayer = CR.createFeaturesLayer(features).addTo(map);
        const walkwaysLayer = CR.createWalkwaysLayer(walkways).addTo(map);

        // NEW: initialize routing tools
        if (CR.initRouting) {
            CR.initRouting(map, walkways);
        }
    })();
</script>

</body>
</html>
